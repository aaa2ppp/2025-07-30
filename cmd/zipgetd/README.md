# zipgetd - HTTP Server for File Archiving Service

Серверная часть системы для создания архивов из файлов по URL. Позволяет создавать задачи на архивирование, добавлять файлы, отслеживать статус и скачивать готовые архивы.

## Ключевые возможности

- REST API для управления задачами архивирования
- Поддержка форматов: PDF, JPEG, PNG, GIF
- Ограничение на количество файлов в задаче (по умолчанию 3)
- Ограничение на параллельные задачи (по умолчанию 3)
- Защита от SSRF-атак
- Детальное логирование операций
- Генерация JSON-отчётов о статусе задач

## Сборка и запуск

```sh
# Собрать сервер
make deps
make bin/zipgetd

# Создайть конфиг
cp env.example .env
vi .env

# Запустить сервер (порт 8080 по умолчанию)
bin/zipgetd
```

### Переменные окружения

```ini
# Уровень логирования (DEBUG, INFO, WARN, ERROR)
LOG_LEVEL=INFO

# Формат логов (yes/no)
LOG_PLAINTEXT=no

# Адрес сервера
SERVER_ADDR=:8080

# Максимальное количество задач (по умолчанию 1000)
MANAGER_MAX_TOTAL=100

# Максимальное количество активных задач (по умолчанию 3)
MANAGER_MAX_ACTIVE=3

# Максимальное количество файлов в задаче (по умолчанию 3)
MANAGER_MAX_FILES=3

# Время жизни задачи (по умолчанию 10m)
MANAGER_TASK_TTL=10m

# Разрешённые MIME-типы
LOADER_ALLOW_MIME="application/pdf image/jpeg image/png image/gif"
```

## API Endpoints

Базовый путь API: `/api`

### 1. Создание задачи

`POST /api/tasks`

Создаёт новую задачу архивирования.

**Ответ:**
```json
{
  "task_id": 123
}
```

### 2. Добавление файла в задачу

`POST /api/tasks/{id}/files`

Добавляет URL файла в задачу.

**Тело запроса:**
```json
{
  "url": "https://example.com/file.jpg"
}
```

**Ошибки:**
- 404 - задача не найдена
- 409 - превышено максимальное количество файлов
- 503 - сервер перегружен

### 3. Получение статуса задачи

`GET /api/tasks/{id}`

Возвращает текущий статус задачи. Когда в задаче 3 файла, возвращает ссылку на архив.

**Ответ:**
```json
{
  "task": {
    "id": 123,
    "files": [
      {
        "url": "https://example.com/file.jpg",
        "content_type": "image/jpeg",
        "real_type": "image/jpeg",
        "orig_name": "file.jpg",
        "name": "file-1.jpg",
        "size": 10240,
        "status": 200,
        "error_msg": ""
      }
    ],
    "created_at": "2025-07-30T12:00:00Z",
    "updated_at": "2025-07-30T12:01:00Z",
    "expires_at": "2025-07-30T12:10:00Z"
  },
  "archive": "/files/task_123.zip"
}
```

### 4. Скачивание архива

`GET /api/tasks/{id}/archive`

Скачивает ZIP-архив с файлами задачи.

**Заголовки ответа:**
```
Content-Type: application/zip
Content-Disposition: attachment; filename="task_123.zip"
```

### 5. Удаление задачи

`DELETE /api/tasks/{id}`

Удаляет задачу и освобождает ресурсы.

## Тестирование

### Интеграционные тесты

Проект включает интеграционный тест, который:

- Запускает сервер `zipgetd` как отдельный процесс.
- Проверяет API через HTTP.
- Тестирует:
  - Создание задач (`POST /api/tasks`)
  - Добавление файлов (`POST /api/tasks/{id}/files`) с лимитом 3
  - Автоматическое формирование ссылки на архив при 3 файлах
  - Ограничение на 3 одновременные обработки (`GET /api/tasks/{id}/archive`)
  - Корректную обработку недоступных/неподдерживаемых файлов
  - Удаление задач (`DELETE /api/tasks/{id}`)
  - Возврат `503 Service Unavailable` при перегрузке  
  - Запрет загрузки с приватных адресов `403 Forbidden`

### Как запустить

```bash
make bin/zipgetd
make integration-test
```

### Важно:

Интеграционные тесты требуют доступа к https://httpbin.org

## Примеры использования

### 1. Создание архива через API

```sh
# Создаём задачу
TASK_ID=$(curl -s -X POST http://localhost:8080/api/tasks | jq -r '.task_id')

# Добавляем файлы
curl -X POST -H "Content-Type: application/json" -d '{"url":"https://example.com/file1.jpg"}' http://localhost:8080/api/tasks/$TASK_ID/files
curl -X POST -H "Content-Type: application/json" -d '{"url":"https://example.com/file2.pdf"}' http://localhost:8080/api/tasks/$TASK_ID/files
curl -X POST -H "Content-Type: application/json" -d '{"url":"https://example.com/file3.png"}' http://localhost:8080/api/tasks/$TASK_ID/files

# Получаем статус (с ссылкой на архив)
curl http://localhost:8080/api/tasks/$TASK_ID | jq

# Скачиваем архив
curl -OJ http://localhost:8080/api/tasks/$TASK_ID/archive
```

### 2. Прямой доступ к архиву

После добавления 3 файлов можно скачать архив по прямой ссылке:
```
/files/task_123.zip
```

## Архитектура

### Основные компоненты

1. **Manager** - управляет жизненным циклом задач:
   - Создание/удаление задач
   - Ограничение параллельных операций
   - Очистка устаревших задач

2. **Loader** - загружает и проверяет файлы:
   - Валидация URL и MIME-типов
   - Проверка сигнатур файлов
   - Генерация безопасных имён файлов
   - Защита от SSRF

3. **API** - REST интерфейс:
   - Маршрутизация запросов
   - Валидация входных данных
   - Сериализация ответов

### Ограничения

1. Максимальное количество активных задач: 3 (настраивается)
2. Максимальное количество файлов в задаче: 3 (настраивается)
3. Поддерживаемые типы файлов: PDF, JPEG, PNG (настраивается)
4. Время жизни задачи: 1 час (настраивается)

## Безопасность

- Валидация всех входных URL
- Проверка MIME-типов и сигнатур файлов
- Защита от SSRF (блокировка приватных IP)
- Генерация безопасных имён файлов
- Ограничение размера заголовков запросов

## Логирование

Сервер пишет логи в stdout в формате JSON (или текстовом). Уровень детализации настраивается через переменные окружения.

Пример лога:
```json
{
  "time": "2025-07-30T12:00:00Z",
  "level": "INFO",
  "msg": "request received",
  "reqID": 123456789,
  "from": "127.0.0.1",
  "method": "POST",
  "url": "/api/tasks/123/files"
}
```

## Ограничения

1. Максимальный размер заголовка запроса: 8KB
2. Таймаут на чтение запроса: 5 секунд
3. Таймаут на запись ответа: 5 минут (для больших архивов)
4. Блокировка загрузки с приватных адресов
